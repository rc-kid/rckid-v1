#include <iostream>
#include <iomanip>

#include "platform/platform.h"
#include "utils/intelhex.h"


#include "config.h"

void sendCommand(uint8_t cmd) {
    if (! i2c::transmit(I2C_ADDRESS, & cmd, 1, nullptr, 0))
        throw STR("Cannot send command " << (int)cmd);
    cpu::delay_ms(10);
}

void sendCommand(uint8_t cmd, uint8_t arg) {
    uint8_t data[] = { cmd, arg};
    if (! i2c::transmit(I2C_ADDRESS, data, 2, nullptr, 0))
        throw STR("Cannot send command " << (int)cmd << ", arg " << (int)arg);
    cpu::delay_ms(10);
}

void readBuffer(uint8_t * buffer) {
    if (! i2c::transmit(I2C_ADDRESS, nullptr, 0, buffer, 32))
        {} // throw STR("Cannot read bootloader's buffer");
}

void writeBuffer(uint8_t const * buffer) {
    uint8_t data[33];
    data[0] = CMD_WRITE_BUFFER;
    for (size_t i = 0; i < 32; ++i)
        data[i+1] = buffer[i];
    if (! i2c::transmit(I2C_ADDRESS, data, 33, nullptr, 0))
        throw STR("Cannot write bootloader's buffer");
}

void fusesTinySeries1(uint8_t * data, char const * chipName) {
    std::cout << "ATTiny Series 1 detected:" << std::endl;
    std::cout << "    chip:               " << std::hex << (unsigned)data[0] << ":" << (unsigned)data[1] << ":" << (unsigned)data[2] << std::endl;
    std::cout << "    FUSE.WDTCFG:        " << (unsigned(data[3])) << std::endl;
    std::cout << "    FUSE.BODCFG:        " << (unsigned(data[4])) << std::endl;
    std::cout << "    FUSE.OSCCFG:        " << (unsigned(data[5])) << std::endl;
    std::cout << "    FUSE.TCD0CFG:       " << (unsigned(data[6])) << std::endl;
    std::cout << "    FUSE.SYSCFG0:       " << (unsigned(data[7])) << std::endl;
    std::cout << "    FUSE.SYSCFG1:       " << (unsigned(data[8])) << std::endl;
    std::cout << "    FUSE.APPEND:        " << (unsigned(data[9])) << std::endl;
    std::cout << "    FUSE.BOOTEND:       " << (unsigned(data[10])) << std::endl;
    std::cout << "    CLKCTRL.MCLKCTRLA:  " << (unsigned(data[11])) << std::endl;
    std::cout << "    CLKCTRL.MCLKCTRLB:  " << (unsigned(data[12])) << std::endl;
    std::cout << "    CLKCTRL.MCLKLOCK:   " << (unsigned(data[13])) << std::endl;
    std::cout << "    CLKCTRL.MCLKSTATUS: " << (unsigned(data[14])) << std::endl;
}

void checkAVRChip(uint8_t * data) {
    uint32_t signature = (data[0] << 16) + (data[1] << 8) + data[2];
    switch (signature) {
        case 0x1e9422: 
            fusesTinySeries1(data, "ATTiny1614");
            break;
        case 0x1e9421:
            fusesTinySeries1(data, "ATTiny1616");
            break;
        case 0x1e9420:
            fusesTinySeries1(data, "ATTiny1617");
            break;
        default:
            throw STR("Unknown chip detected, signature: " << std::hex << (unsigned)data[0] << ":" << (unsigned)data[1] << ":" << (unsigned)data[2]);
    }
}


void enterBootloader() {
    // check that the avr is present
    if (!i2c::transmit(I2C_ADDRESS, nullptr, 0, nullptr, 0))
        throw STR("Device not detected at I2C address " << I2C_ADDRESS);
    cpu::delay_ms(10);
    // to enter the bootloader, pull the AVR_IRQ pin low first
    // gpio::output()
    //
    // reset the AVR
    sendCommand(CMD_RESET);
    // verify that we have proper communications available by writing some stuff and then reading it back
    sendCommand(CMD_CLEAR_INDEX);
    char const * text = "ThisIsATest_DoYouHearMe?12345678\0";
    writeBuffer((uint8_t const *)text);
    sendCommand(CMD_CLEAR_INDEX);
    uint8_t data[33];
    readBuffer(data);
    if (strncmp(text, (char const *)data, 32) != 0) {
        data[32] = 0;
        throw STR("IO Error. Device detected but I2C communication not working:\n   Sent:     " << text << "\n" << "   Received: " << data);
    }
    sendCommand(CMD_INFO);
    sendCommand(CMD_CLEAR_INDEX);
    readBuffer(data);
    checkAVRChip(data);
    sendCommand(CMD_READ_PAGE, 0);
    sendCommand(CMD_CLEAR_INDEX);
    readBuffer(data);
    for (int i = 0; i < 32; ++i)
        std::cout << std::hex << (unsigned)data[i];
    std::cout << std::endl;
}

int main(int argc, char * argv[]) {

    try {
        hex::Program::parse(":100200000C943F010C9473010C9473010C94FE0345\n\
:100210000C94FA030C94F6030C9473010C94580597\n\
:100220000C9473010C9473010C9473010C9473017E\n\
:100230000C9473010C9473010C9472040C9473016C\n\
:100240000C9473010C9473010C9473010C9473015E\n\
:100250000C944D040C9473010C9473010C94730171\n\
:100260000C94D6040C9473010C9473010C947301D8\n\
:100270000C9473010C9473010C947301C80911243C\n\
:100280001FBECFEFCDBFDFE3DEBF80914000809384\n\
:100290004000811105C098ED21E094BF20934100FA\n\
:1002A0008CBB18E3A0E0B8E3E6E1F5E102C00590FD\n\
:1002B0000D92A830B107D9F728E3A8E0B8E301C050\n\
:1002C0001D92A83BB207E1F711E0CFE3D1E004C0F3\n\
:1002D0002197FE010E94230ACE33D107C9F70E945D\n\
:1002E00068060C94650A0C940001FC019081961735\n\
:1002F000B1F0492F461B550B9A0157FF03C03195AA\n\
:1003000021953109223031051CF4608381E0089584\n\
:10031000961718F49F5F9083F9CF9150FCCF80E03F\n\
:100320000895282F30E0F901EC5FFA4690819F3F55\n\
:1003300051F12E503B46D901EC91F0E0DF01AA0FBC\n\
:10034000BB1FAE5FB74C2D913C9121153105D9F003\n\
:10035000492F50E0440F551F240F351FD9016D93CD\n\
:100360007C934FB7F8949F0155E0220F331F5A95A5\n\
:10037000E1F7E0E1E90FE20FF0E0FC5F8081887FC8\n\
:10038000816080834FBF08950F931F93CF93DF93B6\n\
:10039000CDB7DEB72797CDBFDEBF609176388FE649\n\
:1003A00098E30E947501082F6091773880E798E301\n\
:1003B0000E947501182F811101C0102F60917838AB\n\
:1003C00081E798E30E947501811101C0812F90910E\n\
:1003D0007238892B80937238882309F473C0E091B6\n\
:1003E00073388FEFE23120F4F0E0E052FB46808179\n\
:1003F00023E030E029833A8390916F389F83F8940B\n\
:100400001B82A0917438B09175389C91982B9E8373\n\
:100410009C91809589238D838D818C838F8187FF2B\n\
:1004200002C08E818C835E816D814F813C812B81E6\n\
:1004300089819A81E0E7F8E35C93262F3C9300C022\n\
:1004400046FD252F6C9300C05C93362F2C9300C083\n\
:1004500045FD352F6C9300C05C93262F3C9300C064\n\
:1004600044FD252F6C9300C05C93362F2C9300C065\n\
:1004700043FD352F6C9300C05C93262F3C9300C046\n\
:1004800042FD252F6C9300C05C93362F2C9300C047\n\
:1004900041FD352F6C9300C05C93262F3C9300C028\n\
:1004A00040FD252F6C9301975C93362F2C9341913F\n\
:1004B00047FD352F6C9301F64F833C832B83898353\n\
:1004C0009A8378942796CDBFDEBFDF91CF911F919D\n\
:1004D0000F9108951092B638E0EAF0E080818F78AD\n\
:1004E0008083808180618083E0E0F6E086E0818324\n\
:1004F0008DE1868383E5828380E483838FE1858336\n\
:1005000081E080838087089588ED9BE084BF90938D\n\
:100510000001E0E0F4E08789887F878B8789846029\n\
:10052000878B8789877F878BA0E2B4E055968C9173\n\
:100530005597887F55968C93559755968C915597DE\n\
:10054000846055968C93559755968C915597877FD7\n\
:1005500055968C93559754968C915497887F5496C2\n\
:100560008C93549754968C915497846054968C93A2\n\
:10057000549754968C915497877F54968C93828984\n\
:10058000887F828B82898460828B8289877F828B3D\n\
:100590000E946A02E0E4FAE0118280E49CE9848728\n\
:1005A000958783E0808308958091A63882FD05C0F9\n\
:1005B0008091B73881608093B7380895282F30E054\n\
:1005C0008231A8F4F901E052FB4680818F3F79F037\n\
:1005D0002E503B46D901EC91B0E2EB9FF001112483\n\
:1005E000FC5F9085982381E019F480E008958FEFF7\n\
:1005F00008958091B538811112C082E08093B5389A\n\
:1006000086E00E94DE029091A638882329F092604D\n\
:100610009093A6380C94D4029D7F9093A6380895A9\n\
:100620008091B438811112C082E08093B4388EE09A\n\
:100630000E94DE029091A638882329F09160909361\n\
:10064000A6380C94D4029E7F9093A6380895CF9339\n\
:10065000DF93823108F03FC090E0DC01A052BB463E\n\
:100660002C912F3FC1F1FC01EE50FB46E08130E2BE\n\
:10067000E39FF0011124FC5F611130C026833081BB\n\
:10068000232399F4EC01CC5FDA462881309741F1BD\n\
:100690002F3F31F17096E20FF11D3FB7F8942081A2\n\
:1006A000611121C0277F20833FBF82539B46FC01FD\n\
:1006B0009081992381F08C919034D1F09038A9F0F9\n\
:1006C000903149F4853008F0880F9091010A8095A7\n\
:1006D00089238093010ADF91CF9108952583CFCF9D\n\
:1006E000F0E0E0E0DACF2860DECF1092A006F3CF92\n\
:1006F00020E4823009F420E89091920A922359F381\n\
:100700006FB7F8949091800A9E7F9093800A4091F1\n\
:10071000920A30E02095309550E02423352398ED5F\n\
:1007200094BF2093920A90918E0A90FFFCCF9091F3\n\
:10073000800A91609093800A813039F4809150044E\n\
:100740008F77809350046FBFC6CF809151048F770D\n\
:1007500080935104F8CF8231F0F490E0FC01E05234\n\
:10076000FB4620812F3FB9F0FC01EE50FB46E081B3\n\
:10077000E295EE0FF0E0F46060FF0EC021838C5F25\n\
:100780009A46DC018C918061E80FF11D808161FF48\n\
:1007900005C08860808308952283F1CF877FFACFD8\n\
:1007A00060E0009721F08F3F910541F461E081E026\n\
:1007B0000E94270361E081E00C94AB0380932D0A33\n\
:1007C0008091010A80648093010AF4CF60E00C9468\n\
:1007D000AB03615071098109910908F40895EFECA8\n\
:1007E000F7E03197F1F700C00000F3CF0F9304E07A\n\
:1007F0000C9402040F9302E00C9402040F9300E0A7\n\
:100800000C9402040F920FB60F920BB60F921F9228\n\
:100810001124FF921F932F933F934F935F936F93F6\n\
:100820007F938F939F93AF93BF93CF93DF93EF9378\n\
:10083000FF93A2E0B8E3A00FB11DCD91DC91000FB2\n\
:100840000D5FA02FB0E0FC90109761F01F2D169562\n\
:1008500018F041F02296FBCFE991F9913097B9F366\n\
:100860000995F5CFA02FB0E0FC92FF91EF91DF91B9\n\
:10087000CF91BF91AF919F918F917F916F915F9138\n\
:100880004F913F912F911F91FF901F900F900BBEA2\n\
:100890000F900FBE0F900F9118951F920F920FB6E9\n\
:1008A0000F9211242F933F938F939F9320911006C3\n\
:1008B0003091110680917D3890917E38820F931F80\n\
:1008C00080937D3890937E3880917C388F5F8093C1\n\
:1008D0007C389F918F913F912F910F900FBE0F9079\n\
:1008E0001F9018951F920F920FB60F9211242F93FD\n\
:1008F0003F934F935F936F937F938F939F93AF93A8\n\
:10090000BF93EF93FF9381E08093560A60917C3808\n\
:10091000662359F070E080917D3890917E380E9476\n\
:10092000F00960937D3870937E3820917A3881E0A9\n\
:10093000820F80937A3880917B3890E0FC01E15DF2\n\
:10094000F74C208301968F739927982F80937B38DB\n\
:100950008F7191F4911127C08FE498E3F8948093FC\n\
:10096000003890930138789461E080E00E94AB03F6\n\
:1009700060E080E00E94270310927D3810927E385C\n\
:1009800010927C38FF91EF91BF91AF919F918F9121\n\
:100990007F916F915F914F913F912F910F900FBE7B\n\
:1009A0000F901F9018958FE298E3D8CF1F920F9267\n\
:1009B0000FB60F9211242F933F934F935F936F9332\n\
:1009C0007F938F939F93AF93BF93EF93FF93809108\n\
:1009D0001B08982F92789238F1F480912E3880324B\n\
:1009E00040F086EA98E380932C3890932D3810924B\n\
:1009F0002E3880912C3890912D38E0912E3821E0BE\n\
:100A00002E0F20932E38E80FF92FF11D808180934F\n\
:100A10001D0883E011C0903811F590911D08E091F8\n\
:100A20007F3881E08E0F80937F38F0E0E058F74CFC\n\
:100A30009083803271F782E080931A08FF91EF91E2\n\
:100A4000BF91AF919F918F917F916F915F914F91E6\n\
:100A50003F912F910F900FBE0F901F901895982FD8\n\
:100A60009374933479F490E080E00E94E60310924E\n\
:100A70002E38809100389091013880932C389093D3\n\
:100A80002D38C7CF913431F48091B73881FFC1CF71\n\
:100A900084E0D2CF8274823471F2803479F682E0BD\n\
:100AA00080931A088091B73882608093B738C6CF98\n\
:100AB0001F920F920FB60F921124CF92DF92EF92F6\n\
:100AC000FF920F931F932F933F934F935F936F93D7\n\
:100AD0007F938F939F93AF93BF93EF93FF9381E0A7\n\
:100AE000809353014091B0385091B1386091B23841\n\
:100AF0007091B338242F2F73DB01CA01807C2B3314\n\
:100B000009F0E1C026E0B695A795979587952A95B7\n\
:100B1000D1F78F738A019B010027107F8B3309F077\n\
:100B2000C4C08CE036952795179507958A95D1F71F\n\
:100B30000F71DB01CA0188279927AE7F073109F0C1\n\
:100B4000A4C08C019D01E1E1369527951795079585\n\
:100B5000EA95D1F7302F3F716C017D01F6E1F694F3\n\
:100B6000E794D794C794FA95D1F72C2D2F701AE1FA\n\
:100B7000B695A795979587951A95D1F78C01EFEFC4\n\
:100B8000E20FEC3008F06FC0F0E0E753FA4F0C943E\n\
:100B9000230AD5051206D5053306D5053306D50536\n\
:100BA000D5053306D5053306D505EFE13E135DC007\n\
:100BB0002C3009F041C08A51984F0F33110511F4C0\n\
:100BC00085EE97E0855E9740B0E0A0E01AE1880FDF\n\
:100BD000991FAA1FBB1F1A95D1F7A2608093B03846\n\
:100BE0009093B138A093B238B093B3388091B738AE\n\
:100BF00084608093B738FF91EF91BF91AF919F913F\n\
:100C00008F917F916F915F914F913F912F911F91A4\n\
:100C10000F91FF90EF90DF90CF900F900FBE0F904D\n\
:100C20001F9018958B51984F83709927892B09F441\n\
:100C30004DC08CE1831319C044275527607C626046\n\
:100C40002F5F822F90E0B0E0A0E0F6E1880F991FBF\n\
:100C5000AA1FBB1FFA95D1F76F737C7F842B952B4E\n\
:100C6000A62BB72BBBCFEEE1A1CF3F5F832F90E048\n\
:100C7000B0E0A0E0E1E1880F991FAA1FBB1FEA9531\n\
:100C8000D1F744275527607CE9CF0F5F10E030E0B3\n\
:100C900020E05CE0000F111F221F331F5A95D1F78F\n\
:100CA000802B912BA22BB32B99CF91E0980F892FFA\n\
:100CB00090E0B0E0A0E046E0880F991FAA1FBB1F9C\n\
:100CC0004A95D1F7EDCF2F5F822B88CF8DE1B2CF40\n\
:100CD00088EDC1E084BFC093610092E59093020665\n\
:100CE0009AE09093050690E290930306C093000665\n\
:100CF000C093030A9EEF9093260A9093270A9BE0E5\n\
:100D00009093000A7894789484BFC093610087E040\n\
:100D100090E00E94E60390E080E00E94E60362E03B\n\
:100D20008EE00E94AB0362E086E00E94AB038091FC\n\
:100D3000110480688093110480913304806880934B\n\
:100D4000330460E173E08EE00E94910169EF72E08C\n\
:100D500086E00E94910180915004887F8093500426\n\
:100D60008091500484608093500480915004877F68\n\
:100D70008093500480915204887F80935204809124\n\
:100D8000520484608093520480915204877F809340\n\
:100D9000520480E190E00E94E60382E090E00E942D\n\
:100DA000E60381E090E00E94E60380E190E00E948B\n\
:100DB000E6038091A63880618093A638C0934701EE\n\
:100DC0008091520181608093520189E480935001A7\n\
:100DD0000E94840287E090E00E94E603F89410925B\n\
:100DE00013081092190883E08093260486E8809304\n\
:100DF0001C0810921E0881EE80931908C0931308F6\n\
:100E000078941092A3381092A4381092A0381092BF\n\
:100E1000A1381092A5381092A238C093400686E0FF\n\
:100E2000809341068093460683E58093420680E4E2\n\
:100E3000809343068FE180934506C093480661E0A6\n\
:100E400082E00E94AB0360E082E00E942703C3E0DF\n\
:100E5000D0E001E010E200937938109376381093D7\n\
:100E60007738109378380E94C40164E670E080E01F\n\
:100E700090E00E94E903009379381092763810923E\n\
:100E80007738109278380E94C40164E670E080E000\n\
:100E900090E00E94E9032197F1F661E081E00E9471\n\
:100EA000AB0380E890E00E94D00318EDC1E007E0BA\n\
:100EB00020E9622E77247394212C3CED332E45E0FB\n\
:100EC000842E912CA12CB12C56EA452E58E3552E98\n\
:100ED000B9E0FB2ED3E0CD2E8DE1E82E93E5D92E9F\n\
:100EE000DFEF8091B73881FF14C080918038823065\n\
:100EF00009F470C090F58823C9F1813009F43CC031\n\
:100F000010927F38F8948091B7388D7F8093B738EE\n\
:100F100078948091000681FD9DC080910B0680FF32\n\
:100F200099C04091100650911106BA01A6E076953D\n\
:100F30006795AA95E1F720910606283009F403C1C8\n\
:100F400008F064C0223009F4EAC0273009F4BAC0BE\n\
:100F5000E0920606D09202067BC0833009F44EC0B0\n\
:100F6000863070F614BFC0934100CACF8091A63876\n\
:100F70008F7E8093A638C4CF9091A63894609093CA\n\
:100F8000A63810920006F092060690910A0691602B\n\
:100F900090930A061092010621E420930206109213\n\
:100FA000030610920506009300061092510A609203\n\
:100FB0005C0A70925D0A8093550AC092500A1092A2\n\
:100FC0007D3810927E3810927C3810927B381092C7\n\
:100FD0007A3896CF1092000610920A061092500AA4\n\
:100FE000F8948091A6388B7F8093A6384092003881\n\
:100FF0005092013878940E946A0282CF80918138A1\n\
:101000008093AF3890E00E94D0037ACF2D31A1F0C9\n\
:101010002E3109F4A6C0293009F09ACF8091B63854\n\
:101020008617170610F46093B6388EE18093060693\n\
:1010300083E4809302060CC0C1010E94F009660F90\n\
:10104000771F6A3F7105E8F41092AB3800930606EB\n\
:10105000C093080680914B0680FFD2C08091500655\n\
:101060009091510626E0969587952A95E1F7209173\n\
:101070004606263009F4AFC0283009F46DC186E079\n\
:10108000BBC0643F81E07807A0F0D093AB3880917B\n\
:10109000A6388068653521E0720730F0683B714002\n\
:1010A000A8F28091A63880648093A6380E94D4026A\n\
:1010B000CDCF8BE0860F8093AB386B3491E079070E\n\
:1010C00030F7C4CF2091AB382223E1F030E02B5031\n\
:1010D0003F4F452F55274695429FC001439F900D96\n\
:1010E000529F900D1124880F892F881F990B91957D\n\
:1010F000843A21E0920748F0D093AC3882E08093A4\n\
:101100000606A6CF30E020E0E4CF8A3A910518F435\n\
:101110001092AC38F3CF855A8093AC38EFCF8091E2\n\
:10112000A6389091AB38933C50F06038710538F494\n\
:1011300080628093A6380E94D40288E0E0CF8F7D41\n\
:101140008093A638FACF2091A938251739F050930B\n\
:10115000A9388091AA3880FD0E94D402F092060638\n\
:1011600077CF80912111A09120119B01281B31097B\n\
:1011700087FD3395B0E00E94290A9B01AC012652FD\n\
:1011800031414140510967E055954795379527957D\n\
:101190006A95D1F7A5E0B0E00E94380A69332FEFD5\n\
:1011A0007207820792071CF41092AD38D1CE6833D3\n\
:1011B00024E07207810591051CF0D093AD38C8CEAC\n\
:1011C00068537F4F8F4F9F4FA50194010E94040ADF\n\
:1011D0002093AD38BDCE2091A3383091A438820F32\n\
:1011E000932F911D8093A3389093A4388091A538B4\n\
:1011F0008F5F8093A53888E080934606C0934806A9\n\
:101200008091460A80FF82C0C093460A1092B63889\n\
:101210008091B438882391F081508093B438811143\n\
:101220000DC08EE00E94DE029091A638882309F45A\n\
:10123000A4C091609093A6380E94D4028091B538E2\n\
:10124000882391F081508093B53881110DC086E0DC\n\
:101250000E94DE029091A638882309F492C0926021\n\
:101260009093A6380E94D4026091A538662399F025\n\
:1012700070E08091A3389091A4380E94F0096093A7\n\
:10128000A3387093A4388091A738861721F0609313\n\
:10129000A7380E94D4026091A238662399F070E0CA\n\
:1012A0008091A0389091A1380E94F0096093A038F5\n\
:1012B0007093A1388091A838861721F06093A838E0\n\
:1012C0000E94D4021092A3381092A4381092A03831\n\
:1012D0001092A1381092A5381092A2388091B73898\n\
:1012E00080FF11C08091B7388E7F8093B73880918E\n\
:1012F000000484FD08C061E080E00E94AB0360E070\n\
:1013000080E00E9427030E94C401A8958091B7380D\n\
:1013100083FFE7CD1092400AC093460A61E087E060\n\
:101320000E94AB0361E087E00E94270382E090E027\n\
:101330000E94E603109240061092400A81E090E07D\n\
:101340000E94E60380E014BF809300018091B738CB\n\
:1013500083FF1BC08895FACF2091A0383091A13827\n\
:10136000820F932F911D8093A0389093A138809184\n\
:10137000A2388F5F8093A23882CE9E7F9093A6384A\n\
:101380005DCF9D7F9093A6386FCF0E948402A0CD41\n\
:10139000E6EAF8E3108280E7818389EE828382EDBA\n\
:1013A00083831582168217828FEF808780E481877E\n\
:1013B00080E090E0A2E4B0E082879387A487B587BD\n\
:1013C000EFE6F8E313828DE0848384E494E0858380\n\
:1013D000968361E08DE00E94AB0310927938089506\n\
:1013E000AA1BBB1B51E107C0AA1FBB1FA617B7074B\n\
:1013F00010F0A61BB70B881F991F5A95A9F7809567\n\
:101400009095BC01CD010895052E97FB1EF4009424\n\
:101410000E941B0A57FD07D00E94430A07FC03D015\n\
:101420004EF40C941B0A50954095309521953F4FF2\n\
:101430004F4F5F4F089590958095709561957F4FC0\n\
:101440008F4F9F4F0895EE0FFF1F0590F491E02DF1\n\
:101450000994A29FB001B39FC001A39F700D811D8D\n\
:101460001124911DB29F700D811D1124911D0895AD\n\
:101470000E94290AA59F900DB49F900DA49F800DF6\n\
:10148000911D11240895A1E21A2EAA1BBB1BFD0178\n\
:101490000DC0AA1FBB1FEE1FFF1FA217B307E40753\n\
:1014A000F50720F0A21BB30BE40BF50B661F771FAB\n\
:1014B000881F991F1A9469F760957095809590958B\n\
:0E14C0009B01AC01BD01CF010895F894FFCF50\n\
:1014CE0010108000000000101010404000000000BE\n\
:1014DE0010001020408020100804020101020408B0\n\
:1014EE0002040801000000000101010101010202D5\n\
:1014FE0002020000000004050607050403020100B5\n\
:08150E000001020301020300C9\n\
:08151600A6381C381038083813\n\
:0400000300000200F7\n\
:00000001FF");
    } catch (hex::Error const & e) {
        std::cout << e << std::endl;
    }


    // initialize gpio and i2c
    gpio::initialize();
    i2c::initializeMaster();
    try {
        // check if we have AVR ready
        enterBootloader();
        return EXIT_SUCCESS;
    } catch (std::string const & e) {
        std::cerr << e << std::endl;
        return EXIT_FAILURE;
    }
}